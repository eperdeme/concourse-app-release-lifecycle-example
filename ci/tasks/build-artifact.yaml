---
platform: linux

image_resource:
  type: docker-image
  source:
    repository: debian
    tag: "stretch"

inputs:
- name: app
- name: version

outputs:
- name: artifact


run:
  path: sh
  args:
  - -ec
  - |
    export CI_BASE=`pwd`
    export OUTPUT_FOLDER="$CI_BASE/artifact"
    export VERSION=`cat $CI_BASE/version/version`
    # make us relative to the app
    cd $CI_BASE/app

    # debug info
    printf "git sha sum is:"
    cat "$CI_BASE/app/.git/ref"
    echo
    echo "version is: $VERSION"

    # create / simulate something "we compile" so that is our compile step and our compiled source lands in ./target
    mkdir -p ./target
    cp $CI_BASE/app/.git/ref ./target/shasum
    echo $VERSION > ./target/version

    # package our code and put it into our putput folder
    echo "creating output artifact to $OUTPUT_FOLDER/myapp-$VERSION.tgz"
    tar czf $OUTPUT_FOLDER/myapp-$VERSION.tgz target
