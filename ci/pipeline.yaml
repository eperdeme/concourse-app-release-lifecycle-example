resources:
- name: ci-repo
  type: git
  source:
    uri: git@github.com:kw-concourse-example/concourse-app-release-lifecycle-example
    private_key: ((github-private-key))
    branch: master

- name: app-repo
  type: git
  source:
    uri: git@github.com:kw-concourse-example/concourse-example-app
    private_key: ((github-private-key))
    branch: master

- name: app-staging-version
  type: git
  source:
    uri: git@github.com:kw-concourse-example/concourse-example-app
    private_key: ((github-private-key))
    branch: version

- name: staging-artifact-storage
  type: s3
  source:
    bucket: myapp
    disable_ssl: true
    # our internal minio deployed in https://github.com/EugenMayer/concourseci-server-boilerplate
    endpoint: http://minio:9000
    regexp: myapp-*.tgz
    versioned_file: myapp.tgz
    access_key_id: minio
    secret_access_key: changeme

jobs:
- name: build-app
  plan:
  - get: ci-repo
  - get: app-repo
    trigger: true
  - get: app-staging-version
  - task: build-artificat
    file: ci-repo/ci/tasks/build-artifact.yaml
    input_mapping:
      app: app-repo
      version: version
    output_mapping:
      artifact: code-artifact
  - put: staging-artifact-storage
    params:
      file: code-artifact/myapp-*.tgz
