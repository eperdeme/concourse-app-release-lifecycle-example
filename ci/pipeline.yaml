jobs:
- name: build-app
  plan:
  - get: ci-repo
  - get: app-staging-version
    params:
      pre: alpha
  - get: app-repo
    trigger: true
  - task: build-artificat
    file: ci-repo/ci/tasks/build-artifact.yaml
    input_mapping:
      app: app-repo
      version: app-staging-version
    output_mapping:
      artifact: code-artifact
  - put: staging-artifact-storage
    params:
      # this is NOT regexp bu bashism wildcard!!
      file: code-artifact/myapp-*.tgz
  - put: app-staging-version

resources:
- name: ci-repo
  type: git
  source:
    uri: git@github.com:kw-concourse-example/concourse-app-release-lifecycle-example
    private_key: ((github-private-key))
    branch: master

- name: app-repo
  type: git
  source:
    uri: git@github.com:kw-concourse-example/concourse-example-app
    private_key: ((github-private-key))
    branch: master

- name: app-staging-version
  type: semver
  source:
    driver: git
    uri: git@github.com:kw-concourse-example/concourse-example-app
    branch: version
    file: staging-version
    private_key: ((github-private-key))

- name: staging-artifact-storage
  type: s3
  source:
    bucket: myapp
    disable_ssl: true
    # our internal minio deployed in https://github.com/EugenMayer/concourseci-server-boilerplate
    endpoint: http://minio:9000
    # this needs to be actual regexp
    regexp: myapp-(.*).tgz
    access_key_id: minio
    secret_access_key: changeme